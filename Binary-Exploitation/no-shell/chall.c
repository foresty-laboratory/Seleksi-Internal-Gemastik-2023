#include <stdio.h>
#include <stdlib.h>
#include <sys/mman.h>
#include <seccomp.h>

#define MAXSIZE 0x1000

// gcc chall.c -o app/chall -lseccomp

void init_seccomp(void)
{
    scmp_filter_ctx ctx = seccomp_init(SCMP_ACT_KILL);

    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(open), 0);
    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(read), 0);
    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(write), 0);
    
    seccomp_load(ctx);
    seccomp_release(ctx);
}

int main(void)
{
    // disable buffering
    setvbuf(stdin , NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);
    setvbuf(stderr, NULL, _IONBF, 0);

    char *ptr = mmap(NULL, MAXSIZE, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_PRIVATE | MAP_ANONYMOUS, 0, 0);

    if (!ptr)
    {
        perror("mmap");
        exit(1);
    }

    puts("== Shellcode Tester ==");
    puts("Executing shell is disabled by seccomp.");
    puts("Enter your shellcode:");
    
    fgets(ptr, MAXSIZE, stdin);

    puts("Executing shellcode...");
    
    init_seccomp();
    ((void (*)(void))ptr)();

    return 0;
}